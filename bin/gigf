#!/usr/bin/env node

/**
 * Module dependencies.
 */

const prompts = require('prompts');
const { execSync } = require('child_process');

const REPOSITORY_SSH = 'git@github.com:giginc/frontend-templates.git'

const cmd = cmd => {
  try { execSync(cmd) } catch(err) {}
}

(async function() {
  const state = {};

  const questions = [
    {
      type: 'select',
      name: 'dir',
      message: 'ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ',
      choices: [
        { title: 'ã¯ã„', value: true },
        { title: 'ã„ã„ãˆ', value: false },
      ]
    },
    {
      type: prev => prev === true ? 'text' : null,
      name: 'name',
      message: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
      validate: value => value.length === 0 ? `å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“` : true
    },
    {
      type: 'select',
      name: 'template',
      message: 'åˆ©ç”¨ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„',
      choices: [
        { title: 'Simple', value: 'master' },
        { title: 'Pug', value: 'template/pug' },
        { title: 'EJS', value: 'template/ejs' }
      ]
    }
  ];

  Object.assign(state, await prompts(questions));

  if (state.template)
  {
    console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...');

    if (state.template !== 'master') {
      cmd(`git clone -b ${state.template} ${REPOSITORY_SSH}`);
    } else {
      cmd(`git clone ${REPOSITORY_SSH}`);
    }

    console.log('`npm install`ã‚’å®Ÿè¡Œã—ã¾ã™...');

    if (state.dir) {
      cmd(`mv frontend-templates ${state.name} && rm -rf ${state.name}/.git && cd ${state.name} && npm i`);
    } else {
      cmd(`mv frontend-templates/* . && rm -rf frontend-templates .git && npm i`);
    }

    console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æº–å‚™ãŒã§ãã¾ã—ãŸğŸ‰ \n`npm run dev`ã§é–‹ç™ºã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
  }
})();
